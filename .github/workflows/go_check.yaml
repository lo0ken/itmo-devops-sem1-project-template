name: Yandex Cloud CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy-and-test:
    name: Deploy to Yandex Cloud and Run Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install Yandex Cloud CLI
      run: |
        curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
        echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

    - name: Configure Yandex Cloud CLI
      run: |
        yc config profile create ci-profile
        yc config set service-account-key <(echo '${{ secrets.YC_SERVICE_ACCOUNT_KEY }}')
        yc config set cloud-id ${{ secrets.YC_CLOUD_ID }}
        yc config set folder-id ${{ secrets.YC_FOLDER_ID }}

    - name: Install jq
      run: sudo apt-get update && sudo apt-get install -y jq

    - name: Generate SSH key
      run: |
        mkdir -p ~/.ssh
        ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N ""
        chmod 600 ~/.ssh/id_rsa
        chmod 644 ~/.ssh/id_rsa.pub

    - name: Make scripts executable
      run: |
        chmod +x scripts/prepare.sh
        chmod +x scripts/run.sh
        chmod +x scripts/tests.sh

    - name: Build Docker image locally
      run: ./scripts/prepare.sh

    - name: Deploy to Yandex Cloud
      id: deploy
      run: |
        ./scripts/run.sh
        echo "VM_IP=$(cat .vm_ip)" >> $GITHUB_OUTPUT

    - name: Test Level 1
      id: test-level-1
      continue-on-error: true
      run: ./scripts/tests.sh 1

    - name: Test Level 2
      id: test-level-2
      continue-on-error: true
      run: ./scripts/tests.sh 2

    - name: Test Level 3
      id: test-level-3
      continue-on-error: true
      run: ./scripts/tests.sh 3

    - name: Get VM logs on failure
      if: failure()
      run: |
        if [ -f ".vm_ip" ]; then
          VM_IP=$(cat .vm_ip)
          echo "=== Fetching logs from VM: $VM_IP ==="
          ssh -o StrictHostKeyChecking=no ubuntu@$VM_IP "sudo docker-compose -f ~/app/docker-compose.yml logs" || true
        fi

    - name: Check test results
      if: always()
      run: |
        if [[ "${{ steps.test-level-1.outcome }}" == "success" ]] || \
           [[ "${{ steps.test-level-2.outcome }}" == "success" ]] || \
           [[ "${{ steps.test-level-3.outcome }}" == "success" ]]; then
          echo "✓ At least one test level passed successfully!"
          exit 0
        else
          echo "✗ All test levels failed!"
          exit 1
        fi

    - name: Cleanup - Delete VM
      if: always()
      run: |
        if [ -f ".vm_ip" ]; then
          VM_LIST=$(yc compute instance list --format json | jq -r '.[] | select(.name | startswith("prices-api-vm-")) | .id')

          for VM_ID in $VM_LIST; do
            echo "Deleting VM: $VM_ID"
            yc compute instance delete $VM_ID --async || true
          done

          rm -f .vm_ip
        fi